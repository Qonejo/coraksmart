<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorakSmart</title>
    
    <!-- Precargar recursos cr√≠ticos -->
    <link rel="preload" href="{{ url_for('static', filename='style.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='script_fast.js') }}" as="script">
    
    <!-- Importar fuente RPG de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- CSS inline cr√≠tico para carga inmediata -->
    <style>
        body{background:#222;color:#fff;font-family:'Press Start 2P',cursive,monospace;margin:0;padding:0}
        header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:2px solid #fff}
        #logo{max-width:200px;height:auto}
        .rpg-container{display:flex;max-width:1200px;margin:0 auto;padding:20px;gap:20px}
        #productos-panel{flex:2;background:rgba(40,40,40,0.9);border:2px solid #fff;padding:20px}
        #carrito-panel{flex:1;background:rgba(40,40,40,0.9);border:2px solid #fff;padding:20px;position:sticky;top:20px;height:fit-content}
        .productos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px}
        .producto-card{background:rgba(60,60,60,0.9);border:1px solid #888;padding:15px;text-align:center}
        .loading{text-align:center;padding:50px;font-size:1.2rem}
    </style>
    
    <!-- CSS no cr√≠tico -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo de la Tienda" id="logo">
    
    <div class="header-user-info">
        {% if aura_data %}
        <div class="aura-display">
            <div class="aura-info">
                {% if aura_data.points > 0 %}
                    <img src="{{ url_for('static', filename='flame_' + aura_data.level_info.flame_color + '.gif') }}" alt="Aura Flame">
                    <span class="aura-text">Aura: +{{ "{:,.0f}".format(aura_data.points) }} pts</span>
                {% else %}
                    <span>üî• Aura: +0 pts</span>
                {% endif %}
            </div>
            
            <!-- ¬°NUEVA L√ìGICA DE LA BARRA DE PROGRESO! -->
            {% set progress_percent = 0 %}
            {% if aura_data.level_info.level < 7 %}
                {% set next_level = AURA_LEVELS[aura_data.level_info.level + 1] %}
                {% if next_level.points_needed > 0 %}
                    {% set progress_percent = (aura_data.points / next_level.points_needed * 100) | int %}
                    {% if progress_percent > 100 %}{% set progress_percent = 100 %}{% endif %}
                {% endif %}
            {% else %}
                {% set progress_percent = 100 %}
            {% endif %}
            
            <div class="aura-progress-bar">
                <!-- Pasamos el porcentaje como un 'data-attribute' -->
                <div class="aura-progress-fill" data-progress="{{ progress_percent }}"></div>
            </div>
        </div>
        {% endif %}
        
        <div class="header-actions">
            <a href="{{ url_for('perfil_usuario') }}" class="perfil-link">
                <span class="perfil-emoji-header">{{ session.get('logged_in_user_emoji', 'üéÆ') }}</span>
                Mi Perfil
            </a>
            <a href="{{ url_for('niveles_aura') }}" class="lobby-link">üèÜ Niveles</a>
        </div>
    </div>
</header>

    <main class="rpg-container">
        <!-- ===== PANEL IZQUIERDO: PRODUCTOS (UNA SOLA CUADR√çCULA UNIFICADA) ===== -->
        <div id="productos-panel">
            <h2>Objetos a la Venta</h2>
            <div class="productos-grid">

                <!-- Bucle de promociones corregido -->
 {% for id, prod in PRODUCTOS_ORDENADOS if prod.get('promocion') %}
     {% include 'product_card.html' %}
 {% endfor %}

 <!-- Bucle de venta general corregido -->
 {% for id, prod in PRODUCTOS_ORDENADOS if not prod.get('promocion') %}
     {% include 'product_card.html' %}
 {% endfor %}

            </div>
        </div>

        <!-- ===== PANEL DERECHO: INVENTARIO (ESTRUCTURA √öNICA Y LIMPIA) ===== -->
        <div id="carrito-panel">
            <h2>Inventario</h2>
            <div id="carrito-contenido">
                <ul id="carrito-lista">
                    <li class="empty-cart-message">Tu inventario est√° vac√≠o.</li>
                </ul>
            </div>
            <div id="carrito-resumen">
                <div class="total-line">
                    <span>TOTAL:</span>
                    <span id="carrito-total">$0.00</span>
                </div>
                <a id="comprar-btn" href="/comprar" class="boton-comprar disabled">
                    FINALIZAR
COMPRA
                </a>
            </div>
        </div>
    </main>

    <!-- Estructura del Modal de Imagen -->
    <div id="image-modal" class="modal-hidden">
        <span id="close-modal" class="close-button" onclick="closeImageModal()">√ó</span>
        <img id="modal-image" class="modal-content-image">
    </div>
    
    <!-- Script optimizado -->
    <script src="{{ url_for('static', filename='script_fast.js') }}"></script>
</body>
</html>