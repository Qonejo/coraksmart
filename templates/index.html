<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorakSmart</title>
    
    <!-- Precargar recursos cr√≠ticos -->
    <link rel="preload" href="{{ url_for('static', filename='style.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='script_fast.js') }}" as="script">
    
    <!-- Importar fuente RPG de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- CSS inline cr√≠tico para carga inmediata -->
    <style>
        body{background:#222;color:#fff;font-family:'Press Start 2P',cursive,monospace;margin:0;padding:0}
        header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:2px solid #fff}
        #logo{max-width:200px;height:auto}
        .rpg-container{display:flex;max-width:1200px;margin:0 auto;padding:20px;gap:20px}
        #productos-panel{flex:2;background:rgba(40,40,40,0.9);border:2px solid #fff;padding:20px}
        #carrito-panel{flex:1;background:rgba(40,40,40,0.9);border:2px solid #fff;padding:20px;position:sticky;top:20px;height:fit-content}
        .productos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px}
        .producto-card{background:rgba(60,60,60,0.9);border:1px solid #888;padding:15px;text-align:center}
        .loading{text-align:center;padding:50px;font-size:1.2rem}
    </style>
    
    <!-- CSS no cr√≠tico -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo de la Tienda" id="logo">
    
    <div class="header-user-info">
        {% if aura_data %}
        <div class="aura-display">
            <div class="aura-info">
                {% if aura_data.points > 0 %}
                    <img src="{{ url_for('static', filename=aura_data.level_info.character_gif) }}" alt="Aura Character" class="aura-character">
                    <span class="aura-text">Aura: +{{ "{:,.0f}".format(aura_data.points) }} pts</span>
                {% else %}
                    <img src="{{ url_for('static', filename='f0.gif') }}" alt="Aura Character" class="aura-character">
                    <span>Aura: +0 pts</span>
                {% endif %}
            </div>
            
            <!-- ¬°NUEVA L√ìGICA DE LA BARRA DE PROGRESO! -->
            {% set progress_percent = 0 %}
            {% if aura_data.level_info.level < 7 %}
                {% set next_level = AURA_LEVELS[aura_data.level_info.level + 1] %}
                {% if next_level.points_needed > 0 %}
                    {% set progress_percent = (aura_data.points / next_level.points_needed * 100) | int %}
                    {% if progress_percent > 100 %}{% set progress_percent = 100 %}{% endif %}
                {% endif %}
            {% else %}
                {% set progress_percent = 100 %}
            {% endif %}
            
            <div class="aura-progress-bar">
                <!-- Pasamos el porcentaje como un 'data-attribute' -->
                <div class="aura-progress-fill" data-progress="{{ progress_percent }}"></div>
            </div>
            
            <!-- Notificaci√≥n de recompensas pendientes -->
            {% if aura_data.pending_rewards %}
            <div class="pending-rewards-notification" style="margin-top: 5px; padding: 5px 10px; background: rgba(255, 204, 0, 0.2); border: 1px solid #ffcc00; border-radius: 5px; font-size: 9px; color: #ffcc00; animation: pulse 2s infinite;">
                üéÅ Tienes {{ aura_data.pending_rewards|length }} recompensa(s) pendiente(s) - <a href="{{ url_for('niveles_aura') }}" style="color: #ffcc00; text-decoration: underline;">¬°Recl√°malas!</a>
            </div>
            {% endif %}
            
            <!-- Barra de progreso visual removida por solicitud del usuario -->
        </div>
        {% endif %}
        
        <div class="header-actions">
            <a href="{{ url_for('perfil_usuario') }}" class="perfil-link">
                <span class="perfil-emoji-header">{{ session.get('logged_in_user_emoji', 'üéÆ') }}</span>
                Mi Perfil
            </a>
            <a href="{{ url_for('niveles_aura') }}" class="lobby-link">üèÜ Niveles</a>
        </div>
    </div>
</header>

    <main class="rpg-container">
        <!-- ===== PANEL IZQUIERDO: PRODUCTOS (UNA SOLA CUADR√çCULA UNIFICADA) ===== -->
        <div id="productos-panel">
            <h2>Objetos a la Venta</h2>
            <div class="productos-grid">

                <!-- Bucle de promociones corregido -->
 {% for id, prod in PRODUCTOS_ORDENADOS if prod.get('promocion') %}
     {% include 'product_card.html' %}
 {% endfor %}

 <!-- Bucle de venta general corregido -->
 {% for id, prod in PRODUCTOS_ORDENADOS if not prod.get('promocion') %}
     {% include 'product_card.html' %}
 {% endfor %}

            </div>
        </div>

        <!-- ===== PANEL DERECHO: INVENTARIO (ESTRUCTURA √öNICA Y LIMPIA) ===== -->
        <div id="carrito-panel">
            <h2>Inventario</h2>
            <div id="carrito-contenido">
                <ul id="carrito-lista">
                    <li class="empty-cart-message">Tu inventario est√° vac√≠o.</li>
                </ul>
            </div>
            <div id="carrito-resumen">
                <div class="total-line">
                    <span>TOTAL:</span>
                    <span id="carrito-total">$0.00</span>
                </div>
                <a id="comprar-btn" href="/checkout" class="boton-comprar disabled">
                    FINALIZAR
COMPRA
                </a>
            </div>
        </div>
    </main>

    <!-- Estructura del Modal de Imagen -->
    <div id="image-modal" class="modal-hidden">
        <span id="close-modal" class="close-button" onclick="cerrarImagenModal()">√ó</span>
        <img id="modal-image" class="modal-content-image">
    </div>
    
    <!-- Modal de Felicitaciones por Subir de Nivel -->
    <div id="level-up-modal" class="modal-hidden">
        <div class="level-up-content">
            <h2>üéâ ¬°FELICITACIONES! üéâ</h2>
            <div class="celebration-animation">
                <img id="level-character" src="" alt="Character" class="celebration-character">
            </div>
            <h3 id="level-title">¬°Has alcanzado un nuevo nivel!</h3>
            <div class="reward-info">
                <h4>üèÜ Tu Recompensa:</h4>
                <p id="reward-description"></p>
            </div>
            <button id="claim-reward-btn" class="claim-reward-button" onclick="claimReward()">
                ‚ú® RECLAMAR RECOMPENSA ‚ú®
            </button>
            <button id="close-level-modal" class="close-level-button" onclick="closeLevelUpModal()">
                Cerrar
            </button>
        </div>
    </div>
    
    <!-- Script optimizado -->
    <script src="{{ url_for('static', filename='script_fast.js', v='1.1') }}"></script>
    
    <!-- Inicializar galer√≠as de productos -->
    <script>
        // Configurar galer√≠as de productos con im√°genes (principales y adicionales)
        {% for id, prod in PRODUCTOS_ORDENADOS %}
        setProductGallery('{{ id }}', [
            '{{ prod.imagen }}'
            {% if prod.get('imagenes_adicionales') %}
                {% for img_index, img_name in prod.imagenes_adicionales.items() %}
                    , '{{ img_name }}'
                {% endfor %}
            {% endif %}
        ]);
        {% endfor %}
    </script>
    
    <!-- Script para el sistema de nivel -->
    <script>
        // Verificar si el usuario subi√≥ de nivel
        {% if aura_data.progress_bar and aura_data.progress_bar.get('level_up') %}
        window.addEventListener('load', function() {
            showLevelUpModal(
                {{ aura_data.level_info.level }}, 
                "{{ aura_data.progress_bar.reward }}", 
                "{{ aura_data.level_info.character_gif }}"
            );
        });
        {% endif %}
        
        function showLevelUpModal(level, reward, characterGif) {
            document.getElementById('level-character').src = "{{ url_for('static', filename='') }}" + characterGif;
            document.getElementById('level-title').textContent = `¬°Has alcanzado el Nivel ${level}!`;
            document.getElementById('reward-description').textContent = reward;
            document.getElementById('level-up-modal').classList.remove('modal-hidden');
        }
        
        function closeLevelUpModal() {
            document.getElementById('level-up-modal').classList.add('modal-hidden');
        }
        
        async function claimReward() {
            try {
                const response = await fetch('/reclamar_recompensa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('¬°Recompensa reclamada con √©xito! Recibir√°s tu premio en tu pr√≥ximo pedido.');
                    closeLevelUpModal();
                    // Recargar la p√°gina para actualizar el estado
                    location.reload();
                } else {
                    alert(data.message || 'Error al reclamar la recompensa');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reclamar la recompensa');
            }
        }
    </script>
</body>
</html>