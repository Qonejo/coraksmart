<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Perfil de {{ user_emoji }} - Coraksmart</title>
    <!-- Mantenemos el mismo estilo RPG -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: #222; color: #fff; padding: 20px; max-width: 1000px; margin: auto; }
        h1, h2 { border-bottom: 2px solid #fff; padding-bottom: 10px; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .perfil-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .perfil-emoji { font-size: 4em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8em; }
        th, td { border: 1px solid #888; padding: 10px; text-align: left; }
        th { background-color: #444; }
        a { color: #ffcc00; text-decoration: none; }
        ul { padding-left: 20px; margin: 0; }
        
        .emoji-container { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .cambiar-emoji-btn { 
            background: #333; color: #ffcc00; border: 2px solid #ffcc00; 
            padding: 5px 10px; border-radius: 5px; font-size: 8px; cursor: pointer; 
            font-family: 'Press Start 2P', cursive; transition: all 0.3s;
        }
        .cambiar-emoji-btn:hover { background: #ffcc00; color: #000; }
        
        /* Modal selector de emoji */
        .emoji-selector-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000; 
            display: flex; justify-content: center; align-items: center;
        }
        .emoji-selector-content {
            background: #222; border: 4px solid #ffcc00; border-radius: 10px;
            padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .emoji-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px; margin: 20px 0;
        }
        .emoji-option {
            font-size: 2em; cursor: pointer; border: 2px solid #888;
            padding: 10px; transition: all 0.3s; background: #111;
            display: flex; justify-content: center; align-items: center;
            border-radius: 5px;
        }
        .emoji-option:hover { transform: scale(1.1); border-color: #ffcc00; }
        .emoji-option.occupied { opacity: 0.5; cursor: not-allowed; }
        .emoji-option.occupied::after { content: 'üîí'; position: absolute; }
        .close-emoji-btn {
            background: #dc3545; color: #fff; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-family: 'Press Start 2P', cursive;
            font-size: 9px; float: right;
        }
    </style>
</head>
<body>
    <div class="header-nav">
        <a href="{{ url_for('index') }}">< Volver a la Tienda</a>
        <a href="{{ url_for('logout') }}">Cerrar Sesi√≥n</a>
    </div>

    <div class="perfil-header">
        <div class="emoji-container">
            <span class="perfil-emoji">{{ user_emoji }}</span>
            <button class="cambiar-emoji-btn" onclick="openEmojiSelector()">üîÑ Cambiar Avatar</button>
        </div>
        <h1>Mi Perfil</h1>
    </div>

    <h2>Mi Historial de Pedidos</h2>
    <table>
        <thead>
            <tr>
                <th>ID Pedido</th>
                <th>Fecha</th>
                <th>Detalle</th>
                <th>Total</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for pedido in pedidos %}
            <tr>
                <td>{{ pedido.id }}</td>
                <td>{{ pedido.timestamp }}</td>
                <td>
                    <ul>
                    {% for prod_id, cantidad in pedido.detalle.items() %}
                        {% set parts = prod_id.split('-', 1) %}
                        {% set base_id = parts[0] %}
                        {% set variation_id = parts[1] if parts|length > 1 else none %}
                        {% set product_data = PRODUCTOS.get(base_id, {}) %}

                        {% if variation_id and product_data.variaciones %}
                            <li>{{ cantidad }}x {{ product_data.get('nombre', 'Desconocido') }} ({{ variation_id }})</li>
                        {% else %}
                            <li>{{ cantidad }}x {{ product_data.get('nombre', 'Producto Desconocido') }}</li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                </td>
                <td>${{ "%.2f"|format(pedido.total) }}</td>
                <td>{% if pedido.completado %}Enviado ‚úÖ{% else %}Procesando...{% endif %}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5">A√∫n no has realizado ning√∫n pedido.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Zona de peligro para eliminar cuenta -->
    <div style="margin-top: 40px; padding: 20px; border: 2px solid #ff3333; border-radius: 10px; background: rgba(255, 51, 51, 0.1);">
        <h3 style="color: #ff3333; margin-bottom: 15px;">‚ö†Ô∏è Zona de Peligro</h3>
        <p style="font-size: 8px; color: #ccc; margin-bottom: 15px; line-height: 1.4;">
            Al eliminar tu cuenta se perder√°n permanentemente todos tus datos: puntos de aura, historial de pedidos y configuraciones. Esta acci√≥n NO se puede deshacer.
        </p>
        <button onclick="confirmarEliminacionCuenta()" style="background: #ff3333; color: #fff; border: 2px solid #ff6666; padding: 10px 20px; border-radius: 5px; font-family: 'Press Start 2P', cursive; font-size: 8px; cursor: pointer;">
            üóëÔ∏è Eliminar Mi Cuenta
        </button>
    </div>
    
    <!-- Modal selector de emoji -->
    <div id="emoji-selector-modal" class="emoji-selector-modal" style="display: none;">
        <div class="emoji-selector-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #ffcc00; margin: 0;">Cambiar Avatar</h3>
                <button class="close-emoji-btn" onclick="closeEmojiSelector()">‚úï Cerrar</button>
            </div>
            
            <div style="font-size: 10px; color: #ccc; margin-bottom: 15px;">
                Selecciona un nuevo emoji para tu perfil. Los emojis con üîí est√°n ocupados por otros usuarios.
            </div>
            
            <div id="emoji-grid" class="emoji-grid">
                <!-- Los emojis se cargar√°n aqu√≠ -->
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <div style="font-size: 8px; color: #888;">
                    Si cambias tu avatar, mantendr√°s todos tus puntos de aura y pedidos.
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let availableEmojis = [];
        let occupiedEmojis = [];
        
        async function openEmojiSelector() {
            try {
                // Cargar emojis disponibles
                const response = await fetch('/api/get-emojis');
                const data = await response.json();
                
                availableEmojis = data.all_emojis;
                occupiedEmojis = data.occupied_emojis;
                
                renderEmojiGrid();
                document.getElementById('emoji-selector-modal').style.display = 'flex';
            } catch (error) {
                alert('Error al cargar emojis disponibles');
            }
        }
        
        function closeEmojiSelector() {
            document.getElementById('emoji-selector-modal').style.display = 'none';
        }
        
        function renderEmojiGrid() {
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';
            
            availableEmojis.forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-option';
                emojiDiv.textContent = emoji;
                
                const isOccupied = occupiedEmojis.includes(emoji);
                const isCurrentUser = emoji === '{{ user_emoji }}';
                
                if (isOccupied && !isCurrentUser) {
                    emojiDiv.classList.add('occupied');
                } else {
                    emojiDiv.addEventListener('click', () => selectEmoji(emoji));
                }
                
                if (isCurrentUser) {
                    emojiDiv.style.borderColor = '#00ff00';
                    emojiDiv.style.background = '#004400';
                }
                
                grid.appendChild(emojiDiv);
            });
        }
        
        async function selectEmoji(newEmoji) {
            if (newEmoji === '{{ user_emoji }}') {
                alert('Ya tienes este emoji seleccionado');
                return;
            }
            
            if (confirm(`¬øEst√°s seguro de cambiar tu avatar a ${newEmoji}?`)) {
                try {
                    const response = await fetch('/profile/change-emoji', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ new_emoji: newEmoji })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Avatar cambiado exitosamente');
                        location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error al cambiar el avatar');
                }
            }
        }
        
        // Cerrar modal con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEmojiSelector();
            }
        });
        
        // Cerrar modal al hacer click fuera
        document.getElementById('emoji-selector-modal').addEventListener('click', (e) => {
            if (e.target.id === 'emoji-selector-modal') {
                closeEmojiSelector();
            }
        });
        
        // Funci√≥n para eliminar cuenta
        async function confirmarEliminacionCuenta() {
            const confirmText = prompt('Para confirmar la eliminaci√≥n de tu cuenta, escribe "ELIMINAR" (en may√∫sculas):');
            
            if (confirmText !== 'ELIMINAR') {
                if (confirmText !== null) {
                    alert('Texto incorrecto. Eliminaci√≥n cancelada.');
                }
                return;
            }
            
            if (confirm('¬øEst√°s COMPLETAMENTE SEGURO? Esta acci√≥n eliminar√° permanentemente tu cuenta y todos tus datos.')) {
                try {
                    const response = await fetch('/profile/delete-account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Tu cuenta ha sido eliminada exitosamente.');
                        window.location.href = '/entrar';
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error al eliminar la cuenta');
                }
            }
        }
    </script>
</body>
</html>