{# Este es el archivo templates/product_card.html #}

{# --- Lógica para determinar el estado del producto --- #}
{% set completamente_agotado = false %}
{% if prod.bundle_items %}
    {% set max_bundles_posibles = [] %}
    {% for item_id, cant_nec in prod.bundle_items.items() %}
        {% set item_stock = PRODUCTOS_DICT.get(item_id, {}).get('stock', 0) %}
        {% if cant_nec > 0 %}{% do max_bundles_posibles.append(item_stock // cant_nec) %}{% endif %}
    {% endfor %}
    {% if not max_bundles_posibles or max_bundles_posibles | min <= 0 %}{% set completamente_agotado = true %}{% endif %}
{% elif prod.variaciones %}
    {% set total_stock_variaciones = prod.variaciones.values() | map(attribute='stock') | sum %}
    {% if total_stock_variaciones == 0 %}{% set completamente_agotado = true %}{% endif %}
{% elif prod.stock is defined and prod.stock == 0 %}
    {% set completamente_agotado = true %}
{% endif %}
{# ------------------------------------------------------------------ #}

<div class="producto-item {% if completamente_agotado %}agotado{% endif %} {% if prod.get('promocion') %}promo-item{% endif %}">

    <img src="{{ url_for('static', filename=prod.imagen) }}" alt="{{ prod.nombre }}">
    <div class="producto-nombre">{{ prod.nombre }}</div>

    {% if prod.bundle_items %}
        <!-- Es un Paquete Promocional (siempre es promoción) -->
        <div class="producto-precio promo-precio">${{ "%.2f"|format(prod.bundle_precio) }}</div>
        {% if not completamente_agotado %}
            <button class="boton-agregar" onclick="agregarAlCarrito('{{ id }}')">Añadir Pack</button>
        {% else %}
            <div class="producto-stock stock-agotado">AGOTADO</div>
        {% endif %}

    {% elif prod.variaciones %}
        <!-- Es un producto con variaciones -->
        <div class="variaciones-container">
            {% for var_id, var_data in prod.variaciones.items() %}
                <button class="boton-variacion"
                        onclick="agregarAlCarrito('{{ id }}-{{ var_id }}')"
                        {% if var_data.stock == 0 %}disabled{% endif %}>
                    {{ var_id }} -
                    <!-- Añadimos la clase promo-precio si el producto base es una promoción -->
                    <span class="{% if prod.get('promocion') %}promo-precio{% else %}verde{% endif %}">
                        ${{ "%.2f"|format(var_data.precio) }}
                    </span>
                    <span>(Stock: {{ var_data.stock }})</span>
                </button>
            {% endfor %}
        </div>

    {% else %}
        <!-- Es un producto simple -->
        <!-- Añadimos la clase promo-precio si es una promoción -->
        <div class="producto-precio {% if prod.get('promocion') %}promo-precio{% endif %}">
            ${{ "%.2f"|format(prod.precio) }}
        </div>
        {% if prod.stock > 0 %}
            <div class="producto-stock">Disponibles: {{ prod.stock }}</div>
            <button class="boton-agregar" onclick="agregarAlCarrito('{{ id }}')">Añadir</button>
        {% else %}
            <div class="producto-stock stock-agotado">AGOTADO</div>
        {% endif %}
    {% endif %}

    <div class="producto-descripcion">{{ prod.get('descripcion', '')|safe }}</div>
</div>