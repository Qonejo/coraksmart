<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administraci√≥n - Coraksmart</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: #222; color: #fff; padding: 20px; }
        h1, h2 { border-bottom: 2px solid #fff; padding-bottom: 10px; }
        h3.user-order-header { font-size: 1.5em; color: #ffcc00; border: none; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8em; }
        th, td { border: 1px solid #888; padding: 10px; text-align: left; vertical-align: middle; }
        th { background-color: #444; }
        img { max-width: 50px; height: auto; vertical-align: middle; margin-right: 10px; }
        input[type="number"], input[type="checkbox"] { width: auto; padding: 5px; font-family: inherit; }
        button, .btn { font-family: inherit; font-size: 0.8em; padding: 8px 12px; border: none; cursor: pointer; text-decoration: none; display: inline-block; border-radius: 4px; }
        .logout { float: right; text-decoration: none; color: #ffcc00; }
        .success-message { background-color: #28a745; color: white; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
        .variation-row td { background-color: #3a3a3a; padding-left: 30px; }
        .pedido-completado { background-color: #1a4325; color: #a3ffc3; }
        .pedido-completado td { border-color: #28a745; }
        .actions-cell form { display: inline; margin-left: 5px; }
        .btn-add { background-color: #28a745; color: white; font-size: 1em; margin: 0 10px 20px 0; }
        .btn-bundle { background-color: #fd7e14; color: white; font-size: 1em; margin-bottom: 20px; }
        .btn-update-stock { background-color: #17a2b8; color: white; font-size: 1em; margin-top: 15px; }
        .btn-edit { background-color: #007bff; color: white; }
        .btn-delete { background-color: #dc3545; color: white; }
        .promo-cell { text-align: center; }
        .user-order-section { margin-top: 40px; border: 2px solid #555; padding: 15px; border-radius: 8px; }
        
        /* Estilos para el men√∫ de navegaci√≥n en columnas */
        a[href*="admin"]:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; margin-bottom: 30px;">Panel de Administraci√≥n</h1>
    
    <!-- Men√∫ de navegaci√≥n en forma de columnas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <a href="{{ url_for('admin_configuracion') }}" style="background: #007bff; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            ‚öôÔ∏è<br>Configuraci√≥n
        </a>
        <a href="{{ url_for('admin_emojis') }}" style="background: #8a2be2; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üòÄ<br>Usuarios
        </a>
        <a href="{{ url_for('admin_aura_levels') }}" style="background: #ff6600; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üî•<br>Niveles Aura
        </a>
        <a href="{{ url_for('admin_recompensas') }}" style="background: #ffd700; color: black; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üéÅ<br>Recompensas
        </a>
        <a href="{{ url_for('admin_media') }}" style="background: #28a745; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üñºÔ∏è<br>Medios
        </a>
        <a href="{{ url_for('admin_productos') }}" style="background: #6f42c1; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üì¶<br>Productos
        </a>
        <a href="{{ url_for('logout') }}" style="background: #dc3545; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üö™<br>Cerrar Sesi√≥n
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        {% if category == 'success' %}
          <div class="success-message">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endwith %}

    <h2>Gestionar Productos e Inventario</h2>
    <a href="{{ url_for('admin_productos') }}"><button class="btn-add">üì¶ Gesti√≥n de Productos</button></a>

    <!-- Tabla de vista de productos simplificada -->
    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th>Stock Actual</th>
                <th>Promoci√≥n</th>
                <th>WhatsApp</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for id, prod in PRODUCTOS_ORDENADOS %}
                {% if prod.variaciones %}
                    <tr>
                        <td><img src="{{ url_for('static', filename=prod.imagen) }}"><strong>{{ prod.nombre }}</strong></td>
                        <td><em>(Ver variaciones)</em></td>
                        <td class="promo-cell">
                            <input type="checkbox" {% if prod.get('promocion') %}checked{% endif %} disabled>
                        </td>
                        <td>{{ config.get('whatsapp_' + (prod.get('whatsapp_asignado', '1')) + '_nombre', 'Principal') }}</td>
                        <td class="actions-cell">
                            <a href="{{ url_for('admin_productos') }}" class="btn btn-edit">Gestionar</a>
                        </td>
                    </tr>
                    {% for var_id, var_data in prod.variaciones.items() %}
                        <tr class="variation-row">
                            <td style="padding-left: 40px;">- {{ var_id }}</td>
                            <td>{{ var_data.stock }}</td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td><img src="{{ url_for('static', filename=prod.get('imagen', 'default.png')) }}">{{ prod.get('nombre', 'Nombre no encontrado') }}</td>
                        <td>{{ prod.get('stock', 'N/A') }}</td>
                        <td class="promo-cell">
                            <input type="checkbox" {% if prod.get('promocion') %}checked{% endif %} disabled>
                        </td>
                        <td>{{ config.get('whatsapp_' + (prod.get('whatsapp_asignado', '1')) + '_nombre', 'Principal') }}</td>
                        <td class="actions-cell">
                            <a href="{{ url_for('admin_productos') }}" class="btn btn-edit">Gestionar</a>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <h2>Historial de Pedidos</h2>

    {% if not PEDIDOS_AGRUPADOS %}
        <p>No hay pedidos todav√≠a.</p>
    {% else %}
        {% for emoji, pedidos_del_usuario in PEDIDOS_AGRUPADOS.items() %}
            <div class="user-order-section">
                <h3 class="user-order-header">Pedidos de: {{ emoji }}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID Pedido</th>
                            <th>Fecha y Hora</th>
                            <th>Detalle</th>
                            <th>Total</th>
                            <th>Aura</th>
                            <th>Completado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos_del_usuario %}
                        <tr class="{% if pedido.completado %}pedido-completado{% endif %}">
                            <td>{{ pedido.id }}</td>
                            <td>{{ pedido.timestamp }}</td>
                            <td>
                                <ul>
                                {% for prod_id, cantidad in pedido.detalle.items() %}
                                    {% set parts = prod_id.split('-', 1) %}
                                    {% set base_id = parts[0] %}
                                    {% set variation_id = parts[1] if parts|length > 1 else none %}
                                    {% set product_data = PRODUCTOS.get(base_id, {}) %}

                                    {% if variation_id and product_data.variaciones %}
                                        <li>{{ cantidad }}x {{ product_data.get('nombre', 'Desconocido') }} ({{ variation_id }})</li>
                                    {% else %}
                                        <li>{{ cantidad }}x {{ product_data.get('nombre', 'Producto Desconocido') }}</li>
                                    {% endif %}
                                {% endfor %}
                                </ul>
                            </td>
                            <td>${{ "%.2f"|format(pedido.total) }}</td>
                            <td>
                                {% if pedido.get('aura_otorgada') %}
                                    <span style="color: #00ff00;">‚úÖ {{ pedido.aura_otorgada }} pts</span>
                                {% elif pedido.get('aura_potencial') %}
                                    <span style="color: #ffcc00;">‚è≥ {{ pedido.aura_potencial }} pts</span>
                                {% else %}
                                    <span style="color: #888;">-- pts</span>
                                {% endif %}
                            </td>
                            <td>
                                <form action="{{ url_for('admin_completar_pedido', pedido_id=pedido.id) }}" method="POST" style="margin:0;">
                                    <input type="checkbox" onchange="this.form.submit()" {% if pedido.completado %}checked{% endif %}>
                                </form>
                            </td>
                            <td>
                                <form action="{{ url_for('admin_delete_order', pedido_id=pedido.id) }}" method="POST" style="margin:0;" onsubmit="return confirm('¬øEst√°s seguro de eliminar este pedido?')">
                                    <button type="submit" class="btn btn-delete" style="font-size: 8px; padding: 4px 8px;">üóëÔ∏è</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}
    {% endif %}
</body>
</html>
