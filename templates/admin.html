<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administraci√≥n - Coraksmart</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: #222; color: #fff; padding: 20px; font-size: 10px; }
        h1, h2 { border-bottom: 2px solid #fff; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8em; }
        th, td { border: 1px solid #888; padding: 10px; text-align: left; vertical-align: middle; }
        th { background-color: #444; }
        .btn { font-family: inherit; font-size: 0.8em; padding: 8px 12px; border: none; cursor: pointer; text-decoration: none; display: inline-block; border-radius: 4px; }
        .logout { float: right; text-decoration: none; color: #ffcc00; }
        .success-message { background-color: #28a745; color: white; padding: 10px; margin-bottom: 20px; border-radius: 5px; }

        /* Estilos para la nueva tabla combinada */
        .item-completado { background-color: #1a4325; color: #a3ffc3; }
        .item-completado td { border-color: #28a745; }
        .item-recompensa td { background-color: #3e3b1f; }
        .actions-cell form { display: inline; margin-left: 5px; }
        .btn-delete { background-color: #dc3545; color: white; }
        .item-type-icon { font-size: 1.5em; text-align: center; }

        /* Estilos para el men√∫ de navegaci√≥n en columnas */
        a[href*="admin"]:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; margin-bottom: 30px;">Panel de Administraci√≥n</h1>
    
    <!-- Men√∫ de navegaci√≥n en forma de columnas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <a href="{{ url_for('admin_configuracion') }}" style="background: #007bff; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            ‚öôÔ∏è<br>Configuraci√≥n
        </a>
        <a href="{{ url_for('admin_emojis') }}" style="background: #8a2be2; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üòÄ<br>Usuarios
        </a>
        <a href="{{ url_for('admin_aura_levels') }}" style="background: #ff6600; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üî•<br>Niveles Aura
        </a>
        <a href="{{ url_for('admin_productos') }}" style="background: #6f42c1; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üì¶<br>Productos
        </a>
        <a href="{{ url_for('logout') }}" style="background: #dc3545; color: white; padding: 15px; text-decoration: none; border-radius: 8px; text-align: center; font-size: 12px; transition: all 0.3s; display: block;">
            üö™<br>Cerrar Sesi√≥n
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        {% if category == 'success' %}
          <div class="success-message">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endwith %}

    <h2>Historial General</h2>

    {% if not historial %}
        <p>No hay pedidos ni recompensas pendientes.</p>
    {% else %}
        <table>
            <thead>
                <tr>
                    <th style="width: 5%;">Tipo</th>
                    <th style="width: 5%;">Usuario</th>
                    <th style="width: 20%;">Fecha</th>
                    <th style="width: 40%;">Detalle</th>
                    <th style="width: 10%;">Total</th>
                    <th style="width: 10%;">Estado</th>
                    <th style="width: 10%;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in historial %}
                <tr id="item-{{ item.id }}" class="
                    {% if item.status %}item-completado{% endif %}
                    {% if item.type == 'recompensa' %}item-recompensa{% endif %}">

                    <td class="item-type-icon">
                        {% if item.type == 'pedido' %}üõí
                        {% else %}üéÅ
                        {% endif %}
                    </td>

                    <td>{{ item.user_emoji }}</td>
                    <td>{{ item.timestamp_str }}</td>
                    <td>{{ item.details }}</td>

                    <td>
                        {% if item.type == 'pedido' %}
                            ${{ "%.2f"|format(item.total) }}
                        {% else %}
                            --
                        {% endif %}
                    </td>

                    <td>
                        {% if item.type == 'pedido' %}
                            <form action="{{ url_for('admin_completar_pedido', pedido_id=item.id) }}" method="POST" style="margin:0;">
                                <input type="checkbox" onchange="this.form.submit()" {% if item.status %}checked{% endif %} title="Marcar pedido como completado/pendiente">
                            </form>
                        {% else %}
                             <input type="checkbox" onchange="processReward('{{ item.data.user_emoji }}', {{ item.data.level }}, 'confirm')" title="Confirmar entrega de recompensa">
                        {% endif %}
                    </td>

                    <td>
                        {% if item.type == 'pedido' %}
                            <form action="{{ url_for('admin_delete_order', pedido_id=item.id) }}" method="POST" style="margin:0;" onsubmit="return confirm('¬øEst√°s seguro de eliminar este pedido?')">
                                <button type="submit" class="btn btn-delete" style="font-size: 8px; padding: 4px 8px;">üóëÔ∏è</button>
                            </form>
                        {% else %}
                            <button class="btn btn-delete" style="font-size: 8px; padding: 4px 8px;" onclick="processReward('{{ item.data.user_emoji }}', {{ item.data.level }}, 'reject')" title="Rechazar recompensa">
                                üóëÔ∏è
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <script>
        async function processReward(userEmoji, level, action) {
            const actionText = action === 'confirm' ? 'confirmar la entrega de' : 'rechazar';

            if (!confirm(`¬øEst√°s seguro de ${actionText} esta recompensa?`)) {
                // Si el usuario cancela, y es un checkbox de confirmaci√≥n, desmarcarlo
                if (action === 'confirm') {
                    event.target.checked = false;
                }
                return;
            }

            try {
                const response = await fetch('/admin/recompensas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_emoji: userEmoji,
                        level: level,
                        action: action
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    // Remover la fila de la tabla para que no quede en la vista
                    const row = document.getElementById(`item-${userEmoji}-${level}`);
                    if (row) {
                        row.style.transition = 'opacity 0.5s ease';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 500);
                    }
                } else {
                    alert('Error: ' + data.message);
                    // Si fall√≥ la confirmaci√≥n, desmarcar el checkbox
                    if (action === 'confirm') {
                        event.target.checked = false;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la recompensa');
                if (action === 'confirm') {
                    event.target.checked = false;
                }
            }
        }
    </script>
</body>
</html>
