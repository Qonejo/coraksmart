<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Producto</title>
    <!-- Mismos estilos que add_product.html -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Press Start 2P', cursive; background-color: #222; color: #fff; padding: 20px; }
        h1 { border-bottom: 2px solid #fff; padding-bottom: 10px; }
        form { background-color: #333; padding: 20px; border: 2px solid #888; }
        label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        input[type="text"], input[type="number"], textarea { width: 95%; padding: 10px; font-family: inherit; background-color: #555; border: 1px solid #888; color: #fff; }
        textarea { height: 80px; }
        button, a.btn { font-family: inherit; font-size: 1em; padding: 10px 15px; border: none; cursor: pointer; text-decoration: none; }
        button[type="submit"] { background-color: #007bff; color: white; }
        a.btn { background-color: #6c757d; color: white; display: inline-block; margin-left: 10px; }
    </style>
</head>
<body>
    <h1>Editar: {{ producto.nombre }}</h1>
    <form method="POST" enctype="multipart/form-data">
        <p>
            <label for="nombre">Nombre:</label>
            <input type="text" name="nombre" id="nombre" value="{{ producto.nombre }}" required>
        </p>
        <p>
            <label for="descripcion">Descripci√≥n (acepta HTML):</label>
            <textarea name="descripcion" id="descripcion" rows="4">{{ producto.get('descripcion', '') }}</textarea>
        </p>

        <p>
            <label for="aura_multiplier">Multiplicador de Aura:</label>
            <input type="number" name="aura_multiplier" id="aura_multiplier" step="0.1" value="{{ producto.aura_multiplier | default(3.0) }}" required>
        </p>

        <div class="form-section">
            <label>Tipo de Producto:</label>
            <select id="product-type-selector" name="product_type" style="width: auto;">
                <option value="simple" {% if not producto.variaciones %}selected{% endif %}>Simple (un solo precio/stock)</option>
                <option value="variable" {% if producto.variaciones %}selected{% endif %}>Con Variaciones (diferentes precios/stocks)</option>
            </select>
        </div>

        <!-- Campos para producto simple -->
        <div id="simple-product-fields" class="form-section" {% if producto.variaciones %}style="display: none;"{% endif %}>
            <label>Producto Simple:</label>
            <p>
                <label for="precio">Precio:</label>
                <input type="number" name="precio" id="precio" step="0.01" value="{{ producto.precio if producto.precio is defined else '' }}">
            </p>
            <p>
                <label for="stock">Stock:</label>
                <input type="number" name="stock" id="stock" value="{{ producto.stock if producto.stock is defined else '' }}">
            </p>
        </div>

        <!-- Campos para producto con variaciones -->
        <div id="variable-product-fields" class="form-section" {% if not producto.variaciones %}style="display: none;"{% endif %}>
            <label>Variaciones:</label>
            <div id="variations-container">
                {% if producto.variaciones %}
                    {% for name, data in producto.variaciones.items() %}
                    <div class="variation-row">
                        <input type="hidden" name="variation-key-{{ loop.index }}" value="{{ name }}">
                        <input type="text" name="variation-name-{{ loop.index }}" placeholder="Nombre Variaci√≥n (ej. 28gr)" value="{{ name }}">
                        <input type="number" name="variation-price-{{ loop.index }}" placeholder="Precio" step="0.01" value="{{ data.precio }}">
                        <input type="number" name="variation-stock-{{ loop.index }}" placeholder="Stock" value="{{ data.stock }}">
                        <button type="button" class="btn-remove-variation" onclick="this.parentElement.remove()">Eliminar</button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <button type="button" class="btn-add-variation" onclick="addVariation()">+ Agregar Variaci√≥n</button>
        </div>

        <p>
            <label for="promocion" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" name="promocion" id="promocion" value="true" {% if producto.get('promocion') %}checked{% endif %} style="width: auto;">
                Marcar como Promoci√≥n üè∑Ô∏è
            </label>
        </p>

        <p>
            Imagen Actual: <img src="{{ url_for('static', filename=producto.imagen) }}" style="max-width: 100px;"><br><br>
            <label for="imagen">Subir nueva imagen (deja en blanco para no cambiar):</label>
            <input type="file" name="imagen" id="imagen" accept="image/*">
        </p>
        <p>
            <label for="whatsapp_asignado">WhatsApp Asignado:</label>
            <select name="whatsapp_asignado" id="whatsapp_asignado" style="width: 95%; padding: 10px; font-family: inherit; background-color: #555; border: 1px solid #888; color: #fff;">
                <option value="1" {% if producto.get('whatsapp_asignado', '1') == '1' %}selected{% endif %}>WhatsApp 1 - {{ config.whatsapp_1_nombre or 'Principal' }}</option>
                <option value="2" {% if producto.get('whatsapp_asignado', '1') == '2' %}selected{% endif %}>WhatsApp 2 - {{ config.whatsapp_2_nombre or 'Secundario' }}</option>
                <option value="3" {% if producto.get('whatsapp_asignado', '1') == '3' %}selected{% endif %}>WhatsApp 3 - {{ config.whatsapp_3_nombre or 'Terciario' }}</option>
            </select>
        </p>
        <button type="submit">Guardar Cambios</button>
        <a href="{{ url_for('admin_view') }}" class="btn">Cancelar</a>
    </form>

    <script>
        document.getElementById('product-type-selector').addEventListener('change', function() {
            if (this.value === 'simple') {
                document.getElementById('simple-product-fields').style.display = 'block';
                document.getElementById('variable-product-fields').style.display = 'none';
            } else {
                document.getElementById('simple-product-fields').style.display = 'none';
                document.getElementById('variable-product-fields').style.display = 'block';
            }
        });

        let variationCounter = {{ (producto.variaciones|length if producto.variaciones else 0) + 1 }};
        function addVariation() {
            const container = document.getElementById('variations-container');
            const newRow = document.createElement('div');
            newRow.className = 'variation-row';
            // Use "new" as a key for brand new variations. The backend will handle this.
            newRow.innerHTML = `
                <input type="hidden" name="variation-key-${variationCounter}" value="new-${variationCounter}">
                <input type="text" name="variation-name-${variationCounter}" placeholder="Nombre Variaci√≥n (ej. 28gr)" value="">
                <input type="number" name="variation-price-${variationCounter}" placeholder="Precio" step="0.01" value="">
                <input type="number" name="variation-stock-${variationCounter}" placeholder="Stock" value="">
                <button type="button" class="btn-remove-variation" onclick="this.parentElement.remove()">Eliminar</button>
            `;
            container.appendChild(newRow);
            variationCounter++;
        }
    </script>
</body>
</html>